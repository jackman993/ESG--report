# 產業別分析整合 - 重要路徑資訊

## 關鍵文件路徑

### 1. 產業別分析生成器
**文件**：`C:\Users\User\Desktop\ESG report\ESG--report\company1.1-3.6\industry_analysis.py`

**主要函數**：
```python
generate_industry_analysis(industry, monthly_electricity_bill_ntd, session_id)
```
- 生成 150 字產業別分析
- 判斷耗能等級（高/中/低）
- 計算年營收
- 自動寫入 log

### 2. 內容生成引擎
**文件**：`C:\Users\User\Desktop\ESG report\ESG--report\company1.1-3.6\content_pptx_company.py`

**關鍵方法**：
- `_read_industry_analysis_directly()`：直接從 log 讀取產業別分析（不經過 JSON 解析）
- `generate_cooperation_info()`：生成公司合作概況（優先使用產業別分析）

### 3. Log 文件路徑
**目錄**：`C:\Users\User\Desktop\ESG_Output\_Backend\user_logs\`

**文件格式**：`session_{session_id}_industry_analysis.json`

**關鍵字段**：
```json
{
  "industry": "焊接業",
  "industry_analysis": "150字分析...",
  "energy_level": "中耗能",
  "estimated_annual_revenue_ntd": 54000000
}
```

## Step 1 整合點

### 調用位置
在 Step 1 的「生成 TCFD」按鈕處理函數中，**第一個 LLM 調用**：

```python
from industry_analysis import generate_industry_analysis

# 用戶按「生成 TCFD」時
industry_analysis_data = generate_industry_analysis(
    industry="用戶輸入的產業別",
    monthly_electricity_bill_ntd=用戶輸入的月電費,
    session_id=當前session_id
)

# 然後才生成 TCFD tables
```

### 調用順序
1. **第一個 LLM**：`generate_industry_analysis()` → 寫入 log
2. **第二個 LLM**：生成 TCFD tables（會自動從 log 讀取產業別分析）

## 數據流路徑

### 寫入路徑
```
Step 1 用戶輸入產業別 + 月電費
  ↓
generate_industry_analysis()
  ↓
寫入 log: session_{session_id}_industry_analysis.json
```

### 讀取路徑
```
generate_cooperation_info()
  ↓
_read_industry_analysis_directly()
  ↓
直接從 log 文件讀取（正則提取 industry_analysis 字段）
  ↓
插入 prompt 最前面
```

## 關鍵改進點

1. **不經過 JSON 解析**：直接用正則表達式提取字符串
2. **不經過多層轉換**：不經過 `env_log_reader.py` → `get_prompt_context()`
3. **優先順序**：產業別分析放在 prompt 最前面，標示「必須遵守」

## 測試檢查點

1. 確認 log 文件中有 `industry_analysis` 字段（150字）
2. 確認 `_read_industry_analysis_directly()` 能正確讀取
3. 確認 prompt 最前面包含產業別分析
4. 確認 LLM 輸出使用具體產業別，不是「多元化」

