# 產業別分析整合工作摘要

## 問題背景
LLM 生成內容時沒有使用具體產業別，而是輸出「多元化企業」、「協助各行各業」等通用描述，導致內容不夠具體。

## 根本原因
1. **數據流過於複雜**：產業別經過多層轉換（log → env_log_data → env_context → prompt），容易在轉換過程中丟失
2. **Prompt 順序問題**：產業別說明在示例之後，LLM 優先參考示例中的「多元化」
3. **JSON 解析問題**：經過 JSON 解析和多層轉換，可能導致數據丟失

## 解決方案

### 1. 創建產業別分析生成器（`industry_analysis.py`）
- 在 Step 1 用戶按「生成 TCFD」時，第一個 LLM 調用生成產業別分析（150字）
- 包含：產業別相關規範、市場趨勢、風險分析
- LLM 判斷耗能等級（高/中/低），並計算年營收
- 硬寫入 log 文件

### 2. 直接讀取產業別分析（不經過 JSON 解析）
- 新增 `_read_industry_analysis_directly()` 方法
- 直接用正則表達式從 log 文件提取 `industry_analysis` 字段
- 不經過 `env_log_reader.py` 和 `get_prompt_context()` 的多層轉換
- 直接插入 prompt 最前面

### 3. Prompt 優先順序調整
- 產業別放在 prompt 最前面
- 產業別分析（150字）緊隨其後
- 明確標示「必須遵守」
- 禁止使用「多元化」、「各行各業」等通用描述

## 已完成的修改

### 文件清單
1. **`industry_analysis.py`**（新建）
   - `generate_industry_analysis()`：生成產業別分析
   - `save_industry_analysis_to_log()`：寫入 log

2. **`content_pptx_company.py`**（修改）
   - `_read_industry_analysis_directly()`：直接讀取產業別分析
   - `generate_cooperation_info()`：優先使用產業別分析

3. **`env_log_reader.py`**（修改）
   - `get_prompt_context()`：讀取 `industry_analysis` 字段

4. **`step1_integration_example.py`**（新建）
   - 使用範例，說明如何在 Step 1 中調用

## 待完成工作

### Step 1 整合（最重要）
需要在 Step 1 的「生成 TCFD」按鈕處理函數中：

```python
from industry_analysis import generate_industry_analysis

# 用戶按「生成 TCFD」時
# 1. 第一個 LLM 調用：生成產業別分析
industry_analysis_data = generate_industry_analysis(
    industry=用戶輸入的產業別,
    monthly_electricity_bill_ntd=用戶輸入的月電費,
    session_id=當前session_id
)

# 2. 然後才生成 TCFD tables
# （TCFD tables 會自動從 log 讀取產業別分析）
```

### 測試要點
1. 確認 Step 1 調用 `generate_industry_analysis()` 後，log 文件中有 `industry_analysis` 字段
2. 確認 `generate_cooperation_info()` 能正確讀取並插入 prompt
3. 確認 LLM 輸出使用具體產業別，而不是「多元化」

## 當前狀態
- ✅ 產業別分析生成器已創建
- ✅ 直接讀取邏輯已實現
- ✅ Prompt 優先順序已調整
- ⚠️ **Step 1 整合尚未完成**（需要在 streamlit 應用中調用）

## 關鍵改進
1. **路徑明確**：產業別分析直接從 log 讀取，不經過多層轉換
2. **數據完整**：150字分析包含所有需要的資訊
3. **優先順序**：產業別和產業別分析放在 prompt 最前面
4. **避免丟失**：不經過 JSON 解析，直接用正則提取字符串

## 注意事項
- 確保 Step 1 在生成 TCFD tables 之前先調用 `generate_industry_analysis()`
- log 文件路徑：`C:\Users\User\Desktop\ESG_Output\_Backend\user_logs\`
- 產業別分析會寫入 `session_{session_id}_industry_analysis.json`

